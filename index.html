<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>מיזוג דוחות (CSV בלבד, ללא אינטרנט)</title>
<style>
  :root{--bg:#f7f8fa;--card:#fff;--ink:#0f172a;--muted:#475569;--acc:#4f46e5;}
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Heebo,Arial}
  body{background:linear-gradient(135deg,#eef2ff,#f8fafc);}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  .card{background:var(--card);border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,.07);padding:16px;margin-bottom:14px}
  h1{margin:.2em 0 0.6em;font-size:26px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:800px){.row{grid-template-columns:1fr}}
  label{font-weight:600;margin-bottom:6px;display:block}
  input[type=file]{width:100%}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 14px;border-radius:10px;border:1px solid #cbd5e1;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:1px solid #e2e8f0}
  th,td{padding:8px;border-bottom:1px solid #e2e8f0;font-size:14px;text-align:right}
  .tools{display:flex;gap:8px;flex-wrap:wrap}
  .badge{font-size:12px;border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;background:#f8fafc}
  .err{color:#b91c1c;font-weight:700}
  .ok{color:#166534;font-weight:700}
  .log{font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0b1220;color:#e2e8f0;border-radius:10px;padding:10px;max-height:160px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>מיזוג דוחות לפי מספר עובד — CSV בלבד</h1>
  <div class="card">
    <div class="muted">מותר להעלות כמה קבצים לכל סוג, מכמה חודשים שונים. הדף מאחד לפי <b>עובד/employee_id + תאריך</b>.<br>
    אם אין תאריך מלא — הוא ירכיב מתא <b>חודש</b> (למשל <code>אוק-25</code>) + תא <b>תאריך</b> (היום בחודש).</div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>נוכחות ושעות (attendance) — CSV</label>
        <input type="file" id="f_att" multiple accept=".csv">
        <div class="muted">עמודות שמוכרות: עובד/employee_id, שם עובד, חודש, תאריך (יום בחודש) או date, יום, כניסה, יציאה, סה"כ</div>
      </div>
      <div>
        <label>פעילות — הועברו (activity) — CSV</label>
        <input type="file" id="f_act" multiple accept=".csv">
        <div class="muted">עמודות: הועברו לסגירה / הועברו להמתנה (עם עובד + תאריך)</div>
      </div>
      <div>
        <label>פעולות (actions) — CSV</label>
        <input type="file" id="f_acn" multiple accept=".csv">
        <div class="muted">עמודות: מיילים / שיחות / משימות (ואופציונלי ש-100%/125%/150%)</div>
      </div>
      <div>
        <label>וואטסאפ (whatsapp) — CSV</label>
        <input type="file" id="f_wht" multiple accept=".csv">
        <div class="muted">עמודות: וואטסאפ התקבל / וואטסאפ נענה (עם עובד + תאריך)</div>
      </div>
      <div>
        <label>פתיחת פניות (openings) — CSV</label>
        <input type="file" id="f_opn" multiple accept=".csv">
        <div class="muted">עמודות: פניות שנפתחו (עם עובד + תאריך)</div>
      </div>
    </div>
    <div style="margin-top:12px" class="tools">
      <button id="mergeBtn" class="btn primary">מיזוג לדוח אחד</button>
      <button id="clearBtn" class="btn">ניקוי</button>
      <button id="demoBtn" class="btn">טעינת דוגמה</button>
      <button id="downloadCsv" class="btn" disabled>הורדת דוח (CSV)</button>
      <span id="status" class="badge">מוכן</span>
    </div>
    <div id="msg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>מסננים</label>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr;gap:8px">
          <input id="filterEmp" placeholder="מס' עובד" />
          <input id="filterFrom" type="date" />
          <input id="filterTo" type="date" />
        </div>
        <div class="tools" style="margin-top:8px">
          <button id="applyFilter" class="btn">החלת סינון</button>
        </div>
      </div>
      <div>
        <label>יומן מערכת</label>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tools" style="justify-content:space-between">
      <strong>דוח מאוחד</strong>
      <span id="stats" class="muted">—</span>
    </div>
    <div style="max-height:55vh;overflow:auto;margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>date</th>
            <th>employee_id</th>
            <th>employee_name</th>
            <th>work_hours</th>
            <th>absences</th>
            <th>sick_hours</th>
            <th>vacation_hours</th>
            <th>moved_to_closure</th>
            <th>moved_to_pending</th>
            <th>emails_sent</th>
            <th>calls_logged</th>
            <th>tasks_logged</th>
            <th>whatsapp_received</th>
            <th>whatsapp_replied</th>
            <th>tickets_opened</th>
            <th>overtime_100</th>
            <th>overtime_125</th>
            <th>overtime_150</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* ========= יומן ========= */
const logEl = document.getElementById('log');
function log(msg){ logEl.textContent += (msg + "\n"); logEl.scrollTop = logEl.scrollHeight; }
function setStatus(t){ document.getElementById('status').textContent = t; }

/* ========= CSV Parser קטן (תומך מרכאות) ========= */
function parseCSV(text){
  // מסיר BOM אם קיים
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  const rows = [];
  let cur = '', row = [], i = 0, q = false;
  while (i < text.length){
    const c = text[i];
    if (q){
      if (c === '"'){
        if (text[i+1] === '"'){ cur += '"'; i++; }
        else { q = false; }
      } else { cur += c; }
    } else {
      if (c === '"'){ q = true; }
      else if (c === ','){ row.push(cur); cur=''; }
      else if (c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else if (c === '\r'){ /* דלג */ }
      else { cur += c; }
    }
    i++;
  }
  row.push(cur); rows.push(row);
  // ממיר לשורת אובייקטים
  const headers = rows.shift().map(h=>String(h||'').trim());
  const out = [];
  for (const r of rows){
    if (r.every(x => String(x||'').trim()==='')) continue;
    const o = {};
    headers.forEach((h,idx)=>{ o[h] = r[idx] ?? ''; });
    out.push(o);
  }
  return out;
}

/* ========= עזרי נתונים ========= */
const DEFAULT_ROW = {
  work_hours:0, absences:0, sick_hours:0, vacation_hours:0,
  moved_to_closure:0, moved_to_pending:0,
  emails_sent:0, calls_logged:0, tasks_logged:0,
  whatsapp_received:0, whatsapp_replied:0, tickets_opened:0,
  overtime_100:0, overtime_125:0, overtime_150:0,
  work_location:''
};

const HEB_MONTHS = {
  'ינו':1,'ינואר':1,'פבר':2,'פברואר':2,'מרץ':3,'מרס':3,'אפר':4,'אפריל':4,'מאי':5,
  'יונ':6,'יוני':6,'יול':7,'יולי':7,'אוג':8,'אוגוסט':8,'ספט':9,'ספטמבר':9,
  'אוק':10,'אוקטובר':10,'נוב':11,'נובמבר':11,'דצמ':12,'דצמבר':12
};
function parseHebMonthStr(s){
  if(!s) return null;
  s = String(s).trim();
  const parts = s.split(/[-\s]/).filter(Boolean);
  const mon = HEB_MONTHS[parts[0]];
  if(!mon) return null;
  let year = null;
  if(parts[1]){
    if(/^\d{2}$/.test(parts[1])) year = 2000 + parseInt(parts[1],10);
    else if(/^\d{4}$/.test(parts[1])) year = parseInt(parts[1],10);
  }
  return {month: mon, year};
}
function composeDateFromMonthDay(monthStr, day){
  const md = parseHebMonthStr(monthStr);
  const d = parseInt(day,10);
  if(md && md.year && md.month && d>0 && d<=31){
    const dt = new Date(md.year, md.month-1, d);
    return dt.toISOString().slice(0,10);
  }
  return null;
}
function parseDateSmart(row){
  const norm = {};
  for (const k in row){ norm[String(k).trim().toLowerCase()] = row[k]; }
  // ישירות
  const direct = norm.date || norm['תאריך מלא'] || norm['date '];
  if(direct){
    const d = new Date(direct);
    if(!isNaN(d)) return d.toISOString().slice(0,10);
  }
  // חודש + תאריך (יום בחודש)
  const day = norm['תאריך'] || norm['יום בחודש'] || norm.day;
  const mon = norm['חודש']  || norm.month;
  const comp = composeDateFromMonthDay(mon, day);
  if(comp) return comp;
  // DD/MM/YYYY
  const m = String(norm['תאריך']||'').match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){
    const d = new Date(+m[3], +m[2]-1, +m[1]);
    if(!isNaN(d)) return d.toISOString().slice(0,10);
  }
  return null;
}
function toNumber(v){
  const n = Number(String(v ?? '').replace(/[,\s]/g,''));
  return isFinite(n) ? n : 0;
}

/* ========= קריאת קבצים ========= */
async function readCsvFiles(fileList){
  const all = [];
  for (const f of fileList){
    const txt = await f.text();
    const rows = parseCSV(txt);
    all.push(...rows);
    log(`נקרא: ${f.name} (${rows.length} שורות)`);
  }
  return all;
}

/* ========= מיזוג ========= */
let LAST_ROWS = [];

async function mergeAll(){
  setStatus('מריץ…');
  log('--- התחלת מיזוג ---');
  document.getElementById('msg').innerHTML = '';
  const store = new Map(); // key: empId__date

  function up(row0, mapper){
    // נרמל מפתחות
    const r = {};
    for (const k in row0){ r[String(k).trim().toLowerCase()] = row0[k]; }

    const empId = (r.employee_id ?? r['מספר עובד'] ?? r['עובד'] ?? r.id ?? '').toString().trim();
    const empName = (r.employee_name ?? r['שם עובד'] ?? r['שם'] ?? '').toString().trim();
    if(!empId){ return; }
    const ymd = parseDateSmart(row0);
    if(!ymd){ return; }

    const key = empId + '__' + ymd;
    if(!store.has(key)) store.set(key, { date: ymd, employee_id: empId, employee_name: empName, ...structuredClone(DEFAULT_ROW) });
    const row = store.get(key);
    mapper(r, row);
    if(empName) row.employee_name = empName;
  }

  // קריאה מכל קטגוריה (CSV בלבד)
  const files = {
    attendance: document.getElementById('f_att').files,
    activity:   document.getElementById('f_act').files,
    actions:    document.getElementById('f_acn').files,
    whatsapp:   document.getElementById('f_wht').files,
    openings:   document.getElementById('f_opn').files
  };

  // Attendance
  if(files.attendance.length){
    const rows = await readCsvFiles(files.attendance);
    rows.forEach(obj=>{
      up(obj, (r, row)=>{
        // מתעלמים: חברה, שם חברה, פעולה, מחלקה, רגילות, אחרות, י"ע, י"נ
        const total = r['סה"כ'] ?? r['סה\"כ'] ?? r["סה'כ"] ?? r['סהכ'] ?? r['total'];
        if(total !== undefined && total !== "") row.work_hours += toNumber(total);
        else {
          const tin  = (r['כניסה']||'').toString().trim();
          const tout = (r['יציאה']||'').toString().trim();
          if(tin && tout && /^\d{1,2}:\d{2}$/.test(tin) && /^\d{1,2}:\d{2}$/.test(tout)){
            const [hi,mi] = tin.split(':').map(n=>parseInt(n,10));
            const [ho,mo] = tout.split(':').map(n=>parseInt(n,10));
            const mins = (ho*60+mo) - (hi*60+mi);
            if(isFinite(mins) && mins>0) row.work_hours += mins/60;
          }
        }
        const dayType = (r['יום']||'').toString();
        if(/מהבית/.test(dayType)) row.work_location = 'home';
        else if(/משרד/.test(dayType)) row.work_location = 'office';
      });
    });
  }

  // Activity
  if(files.activity.length){
    const rows = await readCsvFiles(files.activity);
    rows.forEach(obj=>{
      up(obj, (r, row)=>{
        row.moved_to_closure += toNumber(r['moved_to_closure'] ?? r['הועברו לסגירה']);
        row.moved_to_pending += toNumber(r['moved_to_pending'] ?? r['הועברו להמתנה']);
      });
    });
  }

  // Actions
  if(files.actions.length){
    const rows = await readCsvFiles(files.actions);
    rows.forEach(obj=>{
      up(obj, (r, row)=>{
        row.emails_sent += toNumber(r['emails_sent'] ?? r['מיילים'] ?? r['שליחת מייל']);
        row.calls_logged += toNumber(r['calls_logged'] ?? r['שיחות']  ?? r['תיעוד/רישום שיחה']);
        row.tasks_logged += toNumber(r['tasks_logged'] ?? r['משימות']);
        row.overtime_100 = (row.overtime_100||0) + toNumber(r['ש-100%']);
        row.overtime_125 = (row.overtime_125||0) + toNumber(r['125%']);
        row.overtime_150 = (row.overtime_150||0) + toNumber(r['150%']);
      });
    });
  }

  // WhatsApp
  if(files.whatsapp.length){
    const rows = await readCsvFiles(files.whatsapp);
    rows.forEach(obj=>{
      up(obj, (r, row)=>{
        row.whatsapp_received += toNumber(r['whatsapp_received'] ?? r['וואטסאפ התקבל']);
        row.whatsapp_replied  += toNumber(r['whatsapp_replied']  ?? r['וואטסאפ נענה']);
      });
    });
  }

  // Openings
  if(files.openings.length){
    const rows = await readCsvFiles(files.openings);
    rows.forEach(obj=>{
      up(obj, (r, row)=>{
        row.tickets_opened += toNumber(r['tickets_opened'] ?? r['פניות שנפתחו']);
      });
    });
  }

  const arr = [...store.values()].sort((a,b)=>{
    if(a.date!==b.date) return a.date.localeCompare(b.date);
    return (a.employee_id||'').localeCompare(b.employee_id||'');
  });

  LAST_ROWS = arr;
  render(arr);
  setStatus('סיום');
  log(`סיום — ${arr.length} שורות מאוחדות`);
  if(!arr.length){
    document.getElementById('msg').innerHTML = '<span class="err">לא נמצאו שורות — ודאי שיש עמודות "עובד/employee_id" ו-"תאריך" (או "חודש"+"תאריך").</span>';
  }
}

/* ========= טבלה, סינון, יצוא ========= */
function render(rows){
  const tb = document.getElementById('tbody');
  tb.innerHTML = '';
  const fEmp  = document.getElementById('filterEmp').value.trim();
  const fFrom = document.getElementById('filterFrom').value;
  const fTo   = document.getElementById('filterTo').value;
  let shown = 0;
  for (const r of rows){
    if(fEmp && r.employee_id !== fEmp) continue;
    if(fFrom && r.date < fFrom) continue;
    if(fTo && r.date > fTo) continue;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date||''}</td>
      <td>${r.employee_id||''}</td>
      <td>${r.employee_name||''}</td>
      <td style="text-align:end">${r.work_hours??0}</td>
      <td style="text-align:end">${r.absences??0}</td>
      <td style="text-align:end">${r.sick_hours??0}</td>
      <td style="text-align:end">${r.vacation_hours??0}</td>
      <td style="text-align:end">${r.moved_to_closure??0}</td>
      <td style="text-align:end">${r.moved_to_pending??0}</td>
      <td style="text-align:end">${r.emails_sent??0}</td>
      <td style="text-align:end">${r.calls_logged??0}</td>
      <td style="text-align:end">${r.tasks_logged??0}</td>
      <td style="text-align:end">${r.whatsapp_received??0}</td>
      <td style="text-align:end">${r.whatsapp_replied??0}</td>
      <td style="text-align:end">${r.tickets_opened??0}</td>
      <td style="text-align:end">${r.overtime_100??0}</td>
      <td style="text-align:end">${r.overtime_125??0}</td>
      <td style="text-align:end">${r.overtime_150??0}</td>`;
    tb.appendChild(tr);
    shown++;
  }
  document.getElementById('stats').textContent = 'שורות מוצגות: ' + shown;
  document.getElementById('downloadCsv').disabled = rows.length===0;
}

function toCSV(rows){
  const headers = ['date','employee_id','employee_name','work_hours','absences','sick_hours','vacation_hours',
    'moved_to_closure','moved_to_pending','emails_sent','calls_logged','tasks_logged',
    'whatsapp_received','whatsapp_replied','tickets_opened','overtime_100','overtime_125','overtime_150'];
  const lines = [];
  lines.push(headers.join(','));
  for (const r of rows){
    const vals = headers.map(h=>{
      let v = r[h] ?? '';
      v = (typeof v === 'string') ? v.replace(/"/g,'""') : v;
      return `"${v}"`;
    });
    lines.push(vals.join(','));
  }
  return lines.join('\n');
}

document.getElementById('downloadCsv').addEventListener('click', ()=>{
  const csv = toCSV(LAST_ROWS);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'merged_report.csv';
  a.click();
  URL.revokeObjectURL(a.href);
});

document.getElementById('applyFilter').addEventListener('click', ()=> render(LAST_ROWS));

/* ========= כפתורים ========= */
document.getElementById('mergeBtn').addEventListener('click', mergeAll);
document.getElementById('clearBtn').addEventListener('click', ()=>{
  ['f_att','f_act','f_acn','f_wht','f_opn'].forEach(id=> document.getElementById(id).value='');
  LAST_ROWS = [];
  document.getElementById('tbody').innerHTML = '';
  document.getElementById('stats').textContent = '—';
  document.getElementById('downloadCsv').disabled = true;
  document.getElementById('msg').innerHTML = '';
  log('נוקה.');
});

document.getElementById('demoBtn').addEventListener('click', ()=>{
  // יוצר דוגמה משולבת חודש ספט + אוק
  const demoFiles = {
    attendance: [
      {employee_id:'1001','שם עובד':'רות','חודש':'ספט-25','תאריך':'30','כניסה':'08:15','יציאה':'16:45','יום':'עבודה מהבית'},
      {employee_id:'1001','שם עובד':'רות','חודש':'אוק-25','תאריך':'1','סה"כ':'8','יום':'עבודה במשרד'},
      {employee_id:'1002','שם עובד':'דני','חודש':'אוק-25','תאריך':'1','כניסה':'09:00','יציאה':'17:00','יום':'עבודה במשרד'}
    ],
    actions: [
      {employee_id:'1001','שם עובד':'רות','date':'2025-09-30','מיילים':'3','שיחות':'2','משימות':'1'},
      {employee_id:'1001','שם עובד':'רות','date':'2025-10-01','מיילים':'5','שיחות':'4','משימות':'2'},
      {employee_id:'1002','שם עובד':'דני','date':'2025-10-01','מיילים':'2','שיחות':'1','משימות':'1'}
    ],
    activity: [
      {employee_id:'1001','date':'2025-10-01','הועברו לסגירה':'7','הועברו להמתנה':'2'}
    ],
    whatsapp: [
      {employee_id:'1001','date':'2025-10-01','וואטסאפ התקבל':'10','וואטסאפ נענה':'9'}
    ],
    openings: [
      {employee_id:'1001','date':'2025-10-01','פניות שנפתחו':'5'},
      {employee_id:'1002','date':'2025-10-01','פניות שנפתחו':'3'}
    ]
  };

  // מריץ את אותו מנוע על מערכים פנימיים
  const store = new Map();
  function up(row0, mapper){
    const r = {}; for (const k in row0){ r[String(k).trim().toLowerCase()] = row0[k]; }
    const empId = (r.employee_id ?? r['מספר עובד'] ?? r['עובד'] ?? r.id ?? '').toString().trim();
    const empName = (r.employee_name ?? r['שם עובד'] ?? r['שם'] ?? '').toString().trim();
    if(!empId) return;
    let ymd = parseDateSmart(row0);
    if(!ymd) return;
    const key = empId + '__' + ymd;
    if(!store.has(key)) store.set(key, { date: ymd, employee_id: empId, employee_name: empName, ...structuredClone(DEFAULT_ROW) });
    const row = store.get(key);
    mapper(r, row);
    if(empName) row.employee_name = empName;
  }

  demoFiles.attendance.forEach(o=>{
    up(o, (r,row)=>{
      const total = r['סה"כ'] ?? r['סה\"כ'] ?? r["סה'כ"] ?? r['סהכ'] ?? r['total'];
      if(total) row.work_hours += toNumber(total);
      else{
        const tin=r['כניסה'], tout=r['יציאה'];
        if(tin && tout){
          const [hi,mi]=tin.split(':').map(n=>parseInt(n,10));
          const [ho,mo]=tout.split(':').map(n=>parseInt(n,10));
          row.work_hours += ((ho*60+mo)-(hi*60+mi))/60;
        }
      }
      const dayType = (r['יום']||'');
      if(/מהבית/.test(dayType)) row.work_location='home';
      else if(/משרד/.test(dayType)) row.work_location='office';
    });
  });
  demoFiles.actions.forEach(o=>{
    up(o, (r,row)=>{
      row.emails_sent += toNumber(r['מיילים']);
      row.calls_logged += toNumber(r['שיחות']);
      row.tasks_logged += toNumber(r['משימות']);
    });
  });
  demoFiles.activity.forEach(o=>{
    up(o, (r,row)=>{
      row.moved_to_closure += toNumber(r['הועברו לסגירה']);
      row.moved_to_pending += toNumber(r['הועברו להמתנה']);
    });
  });
  demoFiles.whatsapp.forEach(o=>{
    up(o, (r,row)=>{
      row.whatsapp_received += toNumber(r['וואטסאפ התקבל']);
      row.whatsapp_replied  += toNumber(r['וואטסאפ נענה']);
    });
  });
  demoFiles.openings.forEach(o=>{
    up(o, (r,row)=>{
      row.tickets_opened += toNumber(r['פניות שנפתחו']);
    });
  });

  const arr = [...store.values()].sort((a,b)=> a.date.localeCompare(b.date) || a.employee_id.localeCompare(b.employee_id));
  LAST_ROWS = arr;
  render(arr);
  setStatus('דוגמה נטענה');
  log('נטענו נתוני דוגמה: ' + arr.length + ' שורות');
});

/* ========= עזרה מהירה =========
1) ודאי שהקבצים בפורמט CSV (לא XLSX).
2) ודאי שיש כותרת עמודה "עובד" או "employee_id".
3) ודאי שיש "date" מלא או "חודש" + "תאריך" (יום בחודש, מספר).
4) אם עדיין לא עובד — הדביקי כאן שורת כותרות + 2–3 שורות דוגמה, ואתאים את המיפוי.
================================ */
</script>
</body>
</html>
